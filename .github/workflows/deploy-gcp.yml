# GitHub Actions - CI/CD „Éë„Ç§„Éó„É©„Ç§„É≥
# GCP Cloud Run „Å∏„ÅÆËá™Âãï„Éá„Éó„É≠„Ç§

name: Deploy to GCP Cloud Run

on:
  push:
    branches:
      - main          # Êú¨Áï™Áí∞Â¢É„Å∏„ÅÆ„Éá„Éó„É≠„Ç§
      - develop       # „ÉÜ„Çπ„ÉàÁí∞Â¢É„Å∏„ÅÆ„Éá„Éó„É≠„Ç§
  pull_request:
    branches:
      - main
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇíË®±ÂèØ

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-northeast1
  SERVICE_NAME: acrylic-stand-app
  IMAGE_NAME: gcr.io/${{ secrets.GCP_PROJECT_ID }}/acrylic-stand

jobs:
  # ===================================
  # „Éì„É´„Éâ„Å®„ÉÜ„Çπ„Éà
  # ===================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_mysql, gd, zip, mbstring
          coverage: none

      - name: Validate PHP syntax
        run: |
          find api -name "*.php" -print0 | xargs -0 -n1 php -l
          echo "‚úì PHP syntax validation passed"

      - name: Check for sensitive data
        run: |
          if grep -r "hlcz107bb" api/ --exclude-dir=.git; then
            echo "‚ö†Ô∏è  Warning: Hardcoded credentials found"
            exit 1
          fi
          echo "‚úì No hardcoded credentials detected"

  # ===================================
  # GCP „ÉÜ„Çπ„ÉàÁí∞Â¢É„Å∏„ÅÆ„Éá„Éó„É≠„Ç§
  # ===================================
  deploy-staging:
    name: Deploy to Staging (GCP)
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP
        run: gcloud auth configure-docker

      - name: Build Docker image
        run: |
          docker build \
            --tag ${{ env.IMAGE_NAME }}:staging-${{ github.sha }} \
            --tag ${{ env.IMAGE_NAME }}:staging-latest \
            --build-arg APP_ENV=gcp \
            .

      - name: Push Docker image to GCR
        run: |
          docker push ${{ env.IMAGE_NAME }}:staging-${{ github.sha }}
          docker push ${{ env.IMAGE_NAME }}:staging-latest

      - name: Deploy to Cloud Run (Staging)
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }}-staging \
            --image=${{ env.IMAGE_NAME }}:staging-${{ github.sha }} \
            --platform=managed \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars="APP_ENV=gcp,DEBUG_MODE=true" \
            --set-secrets="DB_PASS=db-password:latest" \
            --add-cloudsql-instances=${{ secrets.CLOUD_SQL_INSTANCE }} \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=60s

      - name: Get service URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }}-staging \
            --platform=managed \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "service_url=$URL" >> $GITHUB_OUTPUT
          echo "üöÄ Staging deployed to: $URL"

      - name: Run health check
        run: |
          sleep 10
          curl -f ${{ steps.get-url.outputs.service_url }}/health.php || exit 1
          echo "‚úì Health check passed"

      - name: Comment PR with deployment URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ StagingÁí∞Â¢É„Å´„Éá„Éó„É≠„Ç§„Åï„Çå„Åæ„Åó„ÅüÔºÅ\n\n' +
                    `URL: ${{ steps.get-url.outputs.service_url }}\n` +
                    `Commit: ${context.sha.substring(0, 7)}`
            })

  # ===================================
  # GCP Êú¨Áï™Áí∞Â¢É„Å∏„ÅÆ„Éá„Éó„É≠„Ç§ÔºàÂ∞ÜÊù•Áî®Ôºâ
  # ===================================
  deploy-production:
    name: Deploy to Production (GCP)
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[deploy-prod]')
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP
        run: gcloud auth configure-docker

      - name: Build Docker image
        run: |
          docker build \
            --tag ${{ env.IMAGE_NAME }}:prod-${{ github.sha }} \
            --tag ${{ env.IMAGE_NAME }}:prod-latest \
            --build-arg APP_ENV=gcp \
            .

      - name: Push Docker image to GCR
        run: |
          docker push ${{ env.IMAGE_NAME }}:prod-${{ github.sha }}
          docker push ${{ env.IMAGE_NAME }}:prod-latest

      - name: Deploy to Cloud Run (Production)
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }}-prod \
            --image=${{ env.IMAGE_NAME }}:prod-${{ github.sha }} \
            --platform=managed \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars="APP_ENV=gcp,DEBUG_MODE=false" \
            --set-secrets="DB_PASS=db-password-prod:latest" \
            --add-cloudsql-instances=${{ secrets.CLOUD_SQL_INSTANCE_PROD }} \
            --memory=1Gi \
            --cpu=2 \
            --min-instances=1 \
            --max-instances=50 \
            --timeout=60s \
            --concurrency=80

      - name: Get service URL
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }}-prod \
            --platform=managed \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "üöÄ Production deployed to: $URL"

      - name: Run production health check
        run: |
          sleep 15
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }}-prod \
            --platform=managed \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          curl -f "$URL/health.php" || exit 1
          echo "‚úì Production health check passed"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            Êú¨Áï™Áí∞Â¢É„Å∏„ÅÆ„Éá„Éó„É≠„Ç§ÂÆå‰∫Ü
            Commit: ${{ github.sha }}
          draft: false
          prerelease: false

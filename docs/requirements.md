# 要件定義書（アクリルスタンド工房）

## 1. 目的とスコープ
- ユーザーが画像をアップロードし、オリジナルアクリルスタンドを作成・注文できるようにする。
- 注文情報を店舗（運営）と下請け（製造・発送パートナー）に確実に連携する。
- 現在の実装範囲：画像編集、注文作成、注文管理（管理画面）、ステータス更新、メール通知（顧客・運営・下請け）。
- 非スコープ（将来検討）：実決済ゲートウェイ連携（現状はモック/ペンディング）、在庫管理、発送追跡、領収書自動発行。

## 2. 関係者
- エンドユーザー（購入者）：画像アップロード、デザイン編集、注文・支払い情報入力。
- 店舗運営（ショップ）：注文受付、顧客対応、ステータス更新、売上管理。
- 下請け（製造・発送パートナー）：決済確認後の製造・発送対応。通知先メールは `SUBCONTRACT_EMAIL`。

## 3. ユースケース概要
1) ユーザーが画像をアップロードし、サイズ・台座デザインを選択。
2) 支払い情報フォームに名前・メール・電話・住所を入力し注文送信。
3) バックエンドが注文を保存し、顧客・店舗へメール送信（成功/失敗はレスポンスに含む）。
4) 管理画面で注文一覧・詳細を確認し、ステータスを更新。
5) ステータスが `paid` になったら下請けへ自動メール通知（製造依頼）。

## 4. 機能要件
- 画像編集
  - 画像アップロード（JPG/PNG/GIF/WEBP, 最大10MB）
  - 回転、拡大縮小、台座デザイン選択、プレビュー表示
- 注文作成（フロントエンド `js/payment.js` → API `api/orders.php`）
  - 必須入力: 名前・メール・電話・住所、サイズ、数量、価格
  - 画像データのアップロード (`api/upload.php`) とパス保存
  - 分析データ送信（デバイス、ブラウザ、滞在時間、ページビュー）
- 注文管理 / 照会
  - `GET api/orders.php?order_number=...` で注文取得
  - 管理画面 `admin/index.php` で一覧・詳細表示、絞り込み（ステータス）
- ステータス更新
  - `POST api/update-status.php` で `pending|paid|processing|shipped|completed|cancelled` に更新
  - `paid` への更新時に下請けメール自動送信
- メール通知
  - 注文作成時：顧客宛・運営宛
  - 決済確認（status=paid）時：下請け宛
  - 送信元/宛先設定：`SHOP_ADMIN_EMAIL`（運営, デフォルト `info@zyniqo.co.jp`）、`SHOP_FROM_EMAIL`（送信元, デフォルト `info@zyniqo.co.jp`）、`SUBCONTRACT_EMAIL`（下請け, 環境変数で指定）
  - `mb_send_mail` が無い環境では `mail()` にフォールバック
- セキュリティ
  - 入力サニタイズ、PDOプリペアドステートメント、CORS許可（GET/POST/OPTIONS）
  - `uploads/.htaccess` によるスクリプト実行禁止

## 5. 非機能要件
- パフォーマンス: 通常トラフィックで1リクエスト<1s（画像アップロード除く）
- 可用性: ローカル実行を想定しつつ、メール失敗は処理をブロックしない
- ログ: エラーは `error_log` へ記録

## 6. 現状の制約・未完了項目
- 決済はモック（実決済ゲートウェイ連携なし）。`paid` ステータスは手動/管理画面更新を想定。
- 下請けメール送信先 `SUBCONTRACT_EMAIL` は未設定の場合スキップ。
- 画像データはアップロードAPI経由で保存するが、長期保存/バックアップの方針未決定。
- 認証・認可無し（管理画面は保護されていない）。

## 7. 今後の拡張候補 / ToDo
- 決済連携: 外部決済ゲートウェイ導入、Webhookで `paid` 自動反映。
- 認証/認可: 管理画面ログイン、APIトークン化。
- 通知強化: メールテンプレートHTML化、添付（サムネイル）、再送キュー。
- 配送: 追跡番号登録、発送完了メール自動送信。
- モニタリング: エラーログ集約、健全性チェックエンドポイント。

## 8. 環境変数・設定
- `SHOP_ADMIN_EMAIL` : 運営宛先（デフォルト `info@zyniqo.co.jp`）
- `SHOP_FROM_EMAIL` : 送信元（SPF/DKIM済み推奨, デフォルト `info@zyniqo.co.jp`）
- `SUBCONTRACT_EMAIL` : 下請け宛先（必ず設定）
- DB接続: `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS`, `DB_CHARSET`

## 9. API一覧（主要）
- `POST api/orders.php` : 新規注文作成（JSON）
- `GET api/orders.php?order_number=...` : 注文取得
- `POST api/update-status.php` : ステータス更新（`paid`で下請け通知）
- `POST api/upload.php` : 画像アップロード
- `GET api/order-detail.php?id=...` : 注文詳細取得

## 10. テスト観点（抜粋）
- 正常系: 注文作成→メール送信(顧客/運営)→`paid`更新→下請けメール送信
- 入力バリデーション: メール/電話/必須項目未入力時のエラー
- メール: 宛先未設定時にスキップされること、失敗しても注文処理が成功すること
- セキュリティ: SQLインジェクション防止、アップロード拡張子制限、CORS確認
- 管理画面: ステータス更新の反映、フィルタリング

## 11. 運用手順メモ
- デプロイ時に環境変数 `SHOP_ADMIN_EMAIL`, `SHOP_FROM_EMAIL`, `SUBCONTRACT_EMAIL` を設定
- 決済確認後に管理画面からステータスを `paid` に変更するか、外部決済連携時はWebhookで更新
- メールが届かない場合はサーバーの `sendmail`/SMTP 設定とドメイン認証を確認
